<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Beyond std::vector and std::span. Why and How</title>

  <meta name="description" content="Slides about a C++ talk for custom vector and span implementations">
  <meta name="author" content="Borislav Stanimirov">

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="../lib/reveal.js-3.8.0/css/reveal.min.css" />
  <link rel="stylesheet" href="../lib/reveal.js-3.8.0/css/theme/simple.min.css" id="theme" />
  <link rel="stylesheet" href="../lib/slides.css" />

  <!-- For syntax highlighting -->
  <link rel="stylesheet" href="/third_party/highlight-new/styles/github-gist.css">

  <!-- Slides-specific styles -->
  <link rel="stylesheet" href="custom.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ?
      'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/pdf.min.css' :
      'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/paper.min.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>

  <!--[if lt IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/lib/js/html5shiv.js"></script>
  <![endif]-->
</head>

<body>

  <div class="reveal">
    <div class="slides">
      <section class="title">
        <h1>Beyond <code>std::vector</code> and <code>std::span</code></h1>
        <h2>Why and How</h2>
        <br/>
        <p>
          <a href="http://ibob.bg">Borislav Stanimirov</a> / <a href="https://twitter.com/stanimirovb">@stanimirovb</a>
        </p>
      </section>

      <section class="slide">
        <h3>Hello, World</h3>
        <br/>
        <pre><code class="cpp hljs" data-noescape>
  #include &lt;iostream&gt;

  int main()
  {
      std::cout &lt;&lt; "Hi, I'm Borislav!\n";
      std::cout &lt;&lt; "These slides are here: <span class="fragment hl-code">https://is.gd/bvecspan</span>\n";
      return 0;
  }
        </code></pre>
      </section>

      <section class="slide">
        <h3>Borislav Stanimirov</h3>
        <br/>
        <ul>
          <li>I mostly write <span class="fancy">C++</span></li>
          <li>2006-2018: <span class="fancy">game development</span></li>
          <li>From 2019 on: <span class="fancy">medical software</span></li>
          <li><span class="fancy">Open source</span> software</li>
          <li><a href="https://github.com/iboB" target="_blank">github.com/iboB</a></li>
        </ul>
      </section>

      <section>
        <a href="https://viewray.com" target="_blank"><img class="diagram" src="ViewRay_Logo.png"/></a>
        <br><br>
        <p class="fragment">A blog post of what we do: <a href="https://ibob.bg/blog/2022/01/25/what-we-do-at-viewray/" target="_blank">ibob.bg/blog</a></p>
      </section>

      <section>
        <h2>Standard Library Alternatives</h2>
        <p>Popular in <span class="fancy">multi-platform software</span> and <span class="fancy">game development</span></p>
      </section>

      <section class="slide">
        <h3>Feature Set</h3>
        <br/>
        <ul>
          <li class="fragment">std::string_view arrived in C++17</li>
          <li class="fragment">std::span arrived in C++20.</li>
          <li class="fragment"><code class="cinline">map/set</code> of string pre-C++14 is useless</li>
          <li class="fragment"><code class="cinline">unordered_map/set</code> of string pre-C++20 is useless</li></li>
          <li class="fragment">The language of bad defaults: <span class="fancy">constness, moving, copying</span></li>
          <li class="fragment">...</li>
          <li class="fragment">How Boost came to be</li>
        </ul>
      </section>

      <section class="slide">
        <h3>Performance</h3>
        <br/>
        <ul>
          <li class="fragment"><code class="cinline">iostream</code>: a notoriously bad offender</li>
          <li class="fragment"><code class="finline">flat_map/set</code> in contiguous memory</li>
          <li class="fragment"><code class="cinline">std::hash</code> (this is a documented extension point)</li>
          <li class="fragment">...</li>
        </ul>
      </section>

      <section class="slide">
        <h3>Allocations</h3>
        <br/>
        <ul>
          <li class="fragment">They are <span class="fancy">bad for performance</span></li>
          <li class="fragment"><code class="cinline">map</code>, <code class="cinline">set</code>, <code class="cinline">list</code> allocate every node</li>
          <li class="fragment">this is <em>somewhat</em> understandable</li>
          <li class="fragment"><code class="cinline">unoredered_map/set</code> also allocate every node</li>
          <li class="fragment">No allocator for <code class="cinline">function</code></li>
          <li class="fragment">...</li>
          <li class="fragment">Allocators are notoriously hard to use</li>
        </ul>
      </section>

      <section class="slide">
        <h3>Predictability</h3>
        <br/>
        <ul>
          <li class="fragment">The land of <span class="fancy"><em>"implementation defined"</em></span></li>
          <li class="fragment"><code class="cinline">sizeof std::&lt;pretty-much-anything&gt;</code></li>
          <li class="fragment">Small <code class="cinline">std::string</code> size</li>
          <li class="fragment">Iterators are who-knows-what</li>
          <li class="fragment"><code class="cinline">std::filesystem::path::c_str()</code> returns whatever</li>
          <li class="fragment">...</li>
        </ul>
      </section>

      <section class="slide">
        <h3>Compliance</h3>
        <br/>
        <ul>
          <li class="fragment"><code class="cinline">std::move_if_noexcept</code> <span class="fancy">The Great Divider</span></li>
          <li class="fragment"><code class="cinline">std::function</code> must be copyable</li>
          <li class="fragment"><code class="cinline">std::map::map</code> is not <code>noexcept</code></li>
          <li class="fragment">...</li>
        </ul>
      </section>

      <section>
        <img class="diagram" src="dont.png" />
        <h2>Don't do any of this!</h2>
        <p class="fragment">...usually</p>
      </section>

      <section class="slide">
        <h3>A Warning</h3>
        <br/>
        <ul>
          <li>In most cases the standard library is acceptable</li>
          <li>Make sure you know what you're doing and why</li>
          <li><span class="fancy">Test</span> religiously</li>
          <li>Use <span class="fancy">sanitizers</span></li>
          <li>Always <span class="fancy">benchmark</span></li>
        </ul>
      </section>

      <section class="slide">
        <h3>This Talk</h3>
        <br/>
        <ul>
          <li>A deeper dive in <code class="cinline">std::vector</code> and <code class="cinline">std::span</code></li>
          <li>Likely the most fundamental standard library types</li>
          <li class="fragment">Use cases for altetnatives</li>
          <li class="fragment">Examples of alternatives</li>
          <li class="fragment">Demos</li>
        </ul>
      </section>

      <section>
        <h3><code>std::vector</code></h3>
      </section>

      <section class="slide">
        <h3>Basic Characteristics</h3>
        <br/>
        <ul>
          <li>Holds a <span class="fancy">contiguous</span> block of memory</li>
          <li><span class="fancy">Allocates</span> memory</li>
          <li><span class="fancy">Owns</span> the memory</li>
          <li><span class="fancy">Owns</span> the objects</li>
          <li><span class="fancy">Mutable</span> container</li>
          <li>...of <span class="fancy">mutable</span> objects</li>
          <li>Has a bunch of implementation defined tidbits</li>
        </ul>
      </section>

      <section class="slide">
        <h3>Trivial to Challenge</h3>
        <br/>
        <ul>
          <li class="fragment">Contiguous memory - well, don't use <code class="cinline">std::vector</code></li>
          <li class="fragment">Owns and allocates memory - use <code class="finline">std::span</code></li>
          <li class="fragment">...or at least <code class="cinline">const std::vector&amp;</code></li>
          <li class="fragment">Owns objects - use <code class="finline">std::reference_wrapper</code></li>
          <li class="fragment">Mutable container - use <code class="finline">const std::vector</code></li>
        </ul>
      </section>

      <section>
        <h3><code>my::vector</code></h3>
        <p>A 100% compatible drop-in replacement reimplementation</p>
      </section>

      <section>
        <img class="diagram" src="before-after.webp" />
      </section>

      <section class="slide">
        <h3>Where it Helps</h3>
        <ul>
          <li class="fragment">Predictability</li>
          <ul>
            <li class="fragment">Growth factor</li>
            <li class="fragment">Iterators</li>
            <li class="fragment"><code class="cinline">shrink_to_fit</code> is not required to shrink</li>
          </ul>
          <li class="fragment">Feature set</li>
          <ul class="fragment">
            <li><code class="cinline">emplace</code> returns a ref since C++17</li>
            <li><code class="cinline">noexcept</code> move since C++17</li>
          </ul>
          <li class="fragment">Compliance: <code class="cinline">std::move_if_noexcept</code></li>
          <li class="fragment">Debug performance: not to be underestimated</li>
        </ul>
      </section>

      <section class="slide">
        <h3><code>std::move_if_noexcept</code> Drama</h3>
        <br/>
        <ul>
          <li class="fragment">Moving elements as a whole is a problem</li>
          <li class="fragment">It's impossible to maintain coherency if move throws</li>
          <li class="fragment">Only MS STL deals somewhat gracefully with moves</li>
          <li class="fragment"><a href="https://godbolt.org/z/9hvGcqa3e" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section>
        <p>Speaking of immutable objects</p>
      </section>

      <section>
        <h3>Immutable?</h3>
        <p class="fragment">Think <code class="cinline">std::string_view</code></p>
        <p class="fragment">You don't change. You copy.</p>
        <img class="fragment diagram" src="../immutable-obj/cow.png" />
      </section>

      <section>
        <h3>A Naive Approach</h3>
        <pre><code class="cpp hljs" data-noescape>
    template &lt;typename T&gt;
    class ivector {
      std::vector&lt;T&gt; m_vector;
      // ...
      vector erase(const_iterator i) {
        auto offset = i - begin();
        <span class="fragment hl-code">auto copy = m_vector;</span>
        <span class="fragment hl-code">copy.erase(copy.begin() + offset);</span>
        return {copy};
      }
    };
        </code></pre>
        <p class="fragment">We copied the erased item as well</p>
        <p class="fragment">We allocated more memory</p>
      </section>

      <section>
        <h3>A Better Approach</h3>
        <pre><code class="cpp hljs" data-noescape>
    template &lt;typename T&gt;
    class ivector {
      std::vector&lt;T&gt; m_vector;
      // ...
      vector erase(const_iterator i) {
        auto offset = i - begin();
        std::vector&lt;T&gt; copy;
        <span class="fragment hl-code">copy.reserve(m_vector.size() - 1);</span>
        <span class="fragment hl-code">copy.insert(copy.end(), m_vector.begin(), i);</span>
        <span class="fragment hl-code">copy.insert(copy.end(), i+1, m_vector.end());</span>
        return {copy};
      }
    };
        </code></pre>
      </section>

      <section>
        <p><a href="https://github.com/arximboldi/immer" target="_blank">gh/arximboldi/immer</a> - immutable container library</p>
        <p class="fragment">I've been quite into immutable objects for the past two years.</p>
        <p class="fragment">Let's chat!</p>
      </section>

      <section>
        <p>Most <code class="cinline">std::vector</code> alternatives are there to deal with <span class="fancy">allocations</span>.</p>
        <p class="fragment">So, what about them?</p>
      </section>

      <section class="slide">
        <h3>Allocations</h3>
        <ul>
          <li class="fragment">Obvious cost</li>
          <ul>
            <li class="fragment">The allocator has to do a bunch of stuff.</li>
            <li class="fragment">Potentially make a syscall</li>
            <li class="fragment">Physical memory: pages</li>
            <li class="fragment">Free chunk of consecutive pages</li>
            <li class="fragment">Sync between threads and processes</li>
          </ul>
          <li class="fragment">Commit size - it's very helpful</li>
          <li class="fragment">Not-so-obvious cost</li>
          <ul>
            <li class="fragment">Zeroing/clearing of memory</li>
            <li class="fragment">Fragmentation</li>
          </ul>
        </ul>
      </section>

      <section>
        <p>Rule of thumb: <span class="fancy">Always Avoid Allocations!</span></p>
        <small class="fragment">... unless you <span class="fancy">really</span> know what you're doing</small>
      </section>

      <section class="slide">
        <h3>Custom Allocators</h3>
        <br/>
        <ul>
          <li class="fragment">Usually very hard to use</li>
          <li class="fragment"><code class="cinline">std::pmr</code> helps, but not much</li>
          <li class="fragment">Some kind of management is still needed</li>
          <li class="fragment"><code class="cinline">std::pmr</code> is <span class="fancy">not zero cost</span></li>
          <li class="fragment">Work is being done to improve this</li>
          <li class="fragment">... for C++26</li>
        </ul>
      </section>

      <section>
        <p>Sometimes you can <span class="fancy">completely</span> avoid allocations</p>
      </section>

      <section>
        <p>What if the size is <span class="fancy">always smaller</span> than a given N?</p>
      </section>

      <section>
        <h3><code>std::array</code></h3>
        <p class="fragment">?</p>
      </section>

      <section class="slide">
        <h3><code>std::array</code></h3>
        <br/>
        <ul>
          <li>The size <span class="fancy">always equals</span> N</li>
          <li class="fragment">The size is fixed</li>
          <li class="fragment">What if we use a helper number for actual size?</li>
          <li class="fragment">We still have to <span class="fancy">construct all</span> elements</li>
          <li class="fragment">What if the element is a POD and there are no constructors?</li>
          <li class="fragment">When copying we still have to <span class="fancy">copy all</span> elements</li>
          <li class="fragment"><a href="https://godbolt.org/z/8nv3Mrc3c" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section>
        <h3><code>static_vector</code></h3>
      </section>

      <section class="slide">
        <h3><code>static_vector</code></h3>
        <br/>
        <ul>
          <li>A fixed capacity vector</li>
          <li class="fragment"><a href="https://www.boost.org/doc/libs/1_75_0/doc/html/boost/container/static_vector.html" target="_blank"><code>boost::static_vector</code></a> - a powerful implementation</li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/static_vector.hpp" target="_blank"><code>itlib::static_vector</code></a></li>
          <ul class="fragment">
            <li>90% of the work with 10% of the code</li>
            <li><span class="fancy">No</span> <code class="cinline">std::move_if_noexcept</code></li>
            <li><span class="fancy">No</span> exceptions in <code class="cinline">at</code></li>
          </ul>
          <li class="fragment">No allocations</li>
          <li class="fragment">We copy <span class="fancy">only</span> what we need</li>
          <li class="fragment"><a href="https://godbolt.org/z/7svdfv5s8" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section>
        <p>Can we have the best of all worlds?</p>
      </section>

      <section>
        <h3><code>small_vector</code></h3>
      </section>

      <section class="slide">
        <h3><code>small_vector</code></h3>
        <br/>
        <ul>
          <li>A vector with a small-buffer optimization</li>
          <li class="fragment"><a href="https://www.boost.org/doc/libs/1_75_0/doc/html/boost/container/small_vector.html" target="_blank"><code>boost::small_vector</code></a> - a poweful implementation</li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/small_vector.hpp" target="_blank"><code>itlib::small_vector</code></a></li>
          <ul class="fragment">
            <li>90% of the work with 10% of the code</li>
            <li><span class="fancy">No</span> <code class="cinline">std::move_if_noexcept</code></li>
            <li><span class="fancy">No</span> exceptions in <code class="cinline">at</code></li>
          </ul>
          <li class="fragment">Vectors which have a size smaller than N the majority of the time</li>
          <li class="fragment">...in which case, there are no allocations</li>
          <li class="fragment"><a href="https://godbolt.org/z/q7h17YW35" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section>
        <p>What if the size is absolutely random?</p>
      </section>

      <section>
        <h3><code>std::vector</code></h3>
        <p class="fragment">?</p>
      </section>

      <section class="slide">
        <h3><code>realloc</code></h3>
        <p>We have a block of memory:</p>
        <svg
          id="svg5"
          version="1.1"
          viewBox="0 0 110 147"
          height="297mm"
          width="210mm"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:svg="http://www.w3.org/2000/svg">
          <defs
            id="defs2">
            <rect
              x="219.67997"
              y="654.93706"
              width="190.58103"
              height="56.226431"
              id="rect56160" />
            <rect
              x="228.34774"
              y="569.09299"
              width="188.84409"
              height="48.08055"
              id="rect47254" />
            <rect
              x="153.92422"
              y="421.2544"
              width="349.90058"
              height="106.01861"
              id="rect7494" />
            <rect
              x="153.92422"
              y="421.25439"
              width="349.90057"
              height="106.01861"
              id="rect7494-4" />
            <rect
              x="153.92422"
              y="421.25439"
              width="349.90057"
              height="106.01861"
              id="rect7494-4-3" />
            <rect
              x="219.67998"
              y="654.93707"
              width="190.58102"
              height="56.226433"
              id="rect56160-7" />
          </defs>
          <g
            id="g1169"
            transform="translate(82.462715,146.70711)" />
          <g
            id="g4107"
            transform="translate(-53.718911,-122.88959)">
            <rect
              style="opacity:1;fill:#ff0000;stroke-width:1"
              id="rect2067"
              width="19.999987"
              height="4.9999976"
              x="89.444824"
              y="123.90699" />
            <g
              transform="translate(54.444809,123.90699)"
              id="g2283">
              <g
                id="g2277">
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 5,0 V 5"
                  id="path2239" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 10,0 V 5"
                  id="path2241" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 15,0 V 5"
                  id="path2243" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 20,0 V 5"
                  id="path2245" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 25,0 V 5"
                  id="path2247" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 30,0 V 5"
                  id="path2249" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 35,0 V 5"
                  id="path2251" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 40,0 V 5"
                  id="path2253" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 45,0 V 5"
                  id="path2255" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 50,0 V 5"
                  id="path2257" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 55,0 V 5"
                  id="path2259" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 60,0 V 5"
                  id="path2261" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 65,0 V 5"
                  id="path2263" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 70,0 V 5"
                  id="path2265" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 75,0 V 5"
                  id="path2267" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 80,0 V 5"
                  id="path2269" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 85,0 V 5"
                  id="path2271" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 90,0 V 5"
                  id="path2273" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 95,0 V 5"
                  id="path2275" />
              </g>
              <g
                id="g2279" />
              <rect
                x="0"
                y="0"
                width="100"
                height="5"
                style="fill:none;stroke:#000000;stroke-width:0.264583"
                id="rect2281" />
            </g>
          </g>
          <g
            class="fragment"
            id="g1252">
            <g
              id="g4134"
              transform="translate(-53.301235,-119.09492)">
              <rect
                style="opacity:1;fill:#00ff00;stroke-width:1"
                id="rect2567"
                width="14.999999"
                height="4.9999995"
                x="54.027134"
                y="133.38173" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3"
                width="19.999987"
                height="4.9999976"
                x="89.027138"
                y="133.38173" />
              <g
                transform="translate(54.027133,133.38173)"
                id="g2283-6">
                <g
                  id="g2277-7">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8" />
                </g>
                <g
                  id="g2279-7" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-40.090874,-102.17363)"
              id="text7492"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1675"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1673">x=malloc(3);</tspan></tspan></text>
          </g>
          <text
            xml:space="preserve"
            transform="scale(0.26458333)"
            id="text47252"
            style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:16px;line-height:1.25;font-family:monospace;-inkscape-font-specification:monospace;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect47254);fill:#000000;fill-opacity:1;stroke:none"><tspan
              x="228.34766"
              y="583.25"
              id="tspan1677">
        </tspan><tspan
              x="228.34766"
              y="603.25"
              id="tspan1679">
        </tspan></text>
          <g
            class="fragment"
            id="g1221">
            <g
              id="g4162"
              transform="translate(-52.858073,-116.58132)">
              <rect
                style="opacity:1;fill:#00ff00;stroke-width:1"
                id="rect3427"
                width="15.000002"
                height="4.9999971"
                x="68.583969"
                y="144.13753" />
              <rect
                style="fill:#008000;stroke-width:1"
                id="rect2567-2"
                width="14.999999"
                height="4.9999995"
                x="53.583973"
                y="144.13754" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3-0"
                width="19.999987"
                height="4.9999976"
                x="88.583977"
                y="144.13754" />
              <g
                transform="translate(53.583971,144.13754)"
                id="g2283-6-2">
                <g
                  id="g2277-7-3">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9-8" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6-4" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8-8" />
                </g>
                <g
                  id="g2279-7-4" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9-5" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-39.590249,-89.083092)"
              id="text7492-4"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494-4);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1683"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1681">x=realloc(x, 6);</tspan></tspan></text>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-41.524719,-140.84204)"
              id="text56158"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect56160);fill:#008000;fill-opacity:1;stroke:none"><tspan
                x="219.67969"
                y="669.09375"
                id="tspan1687"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1685">++end</tspan></tspan></text>
          </g>
          <g
            class="fragment"
            id="g1186">
            <g
              id="g4190"
              transform="translate(-52.185531,-111.66571)">
              <rect
                style="fill:#008000;stroke-width:1"
                id="rect2567-2-3"
                width="30.000002"
                height="4.9999957"
                x="108.30364"
                y="155.70898" />
              <rect
                style="fill:#00ff00;stroke-width:1"
                id="rect3427-7"
                width="15.000002"
                height="4.9999971"
                x="138.30365"
                y="155.70898" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3-0-6"
                width="19.999987"
                height="4.9999976"
                x="88.303658"
                y="155.70898" />
              <g
                transform="translate(53.303644,155.70898)"
                id="g2283-6-2-1">
                <g
                  id="g2277-7-3-0">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5-7-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3-5-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5-9-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6-2-0" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2-2-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9-8-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1-9-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2-7-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7-3-4" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0-6-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9-1-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3-2-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6-9-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0-3-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6-1-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2-9-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6-4-4" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1-7-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8-8-2" />
                </g>
                <g
                  id="g2279-7-4-5" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9-5-4" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-39.177179,-72.426849)"
              id="text7492-4-0"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494-4-3);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1691"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1689">x=realloc(x, 9);</tspan></tspan></text>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,4.1827267,-124.75277)"
              id="text56158-8"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect56160-7);fill:#008000;fill-opacity:1;stroke:none"><tspan
                x="219.67969"
                y="669.09375"
                id="tspan1693">memcpy</tspan></text>
          </g>
        </svg>
      </section>

      <section class="slide">
        <h3><code>_expand</code> (Windows only)</h3>
        <p>We have a block of memory (on Windows):</p>
        <svg
          id="svg5"
          version="1.1"
          viewBox="0 0 110 147"
          height="297mm"
          width="210mm"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:svg="http://www.w3.org/2000/svg">
          <defs
            id="defs2">
            <rect
              x="219.67997"
              y="654.93706"
              width="190.58103"
              height="56.226431"
              id="rect56160" />
            <rect
              x="228.34774"
              y="569.09299"
              width="188.84409"
              height="48.08055"
              id="rect47254" />
            <rect
              x="153.92422"
              y="421.2544"
              width="349.90058"
              height="106.01861"
              id="rect7494" />
            <rect
              x="153.92422"
              y="421.25439"
              width="349.90057"
              height="106.01861"
              id="rect7494-4" />
            <rect
              x="153.92422"
              y="421.25439"
              width="349.90057"
              height="106.01861"
              id="rect7494-4-3" />
            <rect
              x="219.67998"
              y="654.93707"
              width="190.58102"
              height="56.226433"
              id="rect56160-7" />
          </defs>
          <g
            id="g1169"
            transform="translate(82.462715,146.70711)" />
          <g
            id="g4107"
            transform="translate(-53.718911,-122.88959)">
            <rect
              style="opacity:1;fill:#ff0000;stroke-width:1"
              id="rect2067"
              width="19.999987"
              height="4.9999976"
              x="89.444824"
              y="123.90699" />
            <g
              transform="translate(54.444809,123.90699)"
              id="g2283">
              <g
                id="g2277">
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 5,0 V 5"
                  id="path2239" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 10,0 V 5"
                  id="path2241" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 15,0 V 5"
                  id="path2243" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 20,0 V 5"
                  id="path2245" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 25,0 V 5"
                  id="path2247" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 30,0 V 5"
                  id="path2249" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 35,0 V 5"
                  id="path2251" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 40,0 V 5"
                  id="path2253" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 45,0 V 5"
                  id="path2255" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 50,0 V 5"
                  id="path2257" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 55,0 V 5"
                  id="path2259" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 60,0 V 5"
                  id="path2261" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 65,0 V 5"
                  id="path2263" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 70,0 V 5"
                  id="path2265" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 75,0 V 5"
                  id="path2267" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 80,0 V 5"
                  id="path2269" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 85,0 V 5"
                  id="path2271" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 90,0 V 5"
                  id="path2273" />
                <path
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  d="M 95,0 V 5"
                  id="path2275" />
              </g>
              <g
                id="g2279" />
              <rect
                x="0"
                y="0"
                width="100"
                height="5"
                style="fill:none;stroke:#000000;stroke-width:0.264583"
                id="rect2281" />
            </g>
          </g>
          <g
            class="fragment"
            id="g1252">
            <g
              id="g4134"
              transform="translate(-53.301235,-119.09492)">
              <rect
                style="opacity:1;fill:#00ff00;stroke-width:1"
                id="rect2567"
                width="14.999999"
                height="4.9999995"
                x="54.027134"
                y="133.38173" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3"
                width="19.999987"
                height="4.9999976"
                x="89.027138"
                y="133.38173" />
              <g
                transform="translate(54.027133,133.38173)"
                id="g2283-6">
                <g
                  id="g2277-7">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8" />
                </g>
                <g
                  id="g2279-7" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-40.090874,-102.17363)"
              id="text7492"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1675"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1673">x=malloc(3);</tspan></tspan></text>
          </g>
          <text
            xml:space="preserve"
            transform="scale(0.26458333)"
            id="text47252"
            style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:16px;line-height:1.25;font-family:monospace;-inkscape-font-specification:monospace;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect47254);fill:#000000;fill-opacity:1;stroke:none"><tspan
              x="228.34766"
              y="583.25"
              id="tspan1677">
        </tspan><tspan
              x="228.34766"
              y="603.25"
              id="tspan1679">
        </tspan></text>
          <g
            class="fragment"
            id="g1221">
            <g
              id="g4162"
              transform="translate(-52.858073,-116.58132)">
              <rect
                style="opacity:1;fill:#00ff00;stroke-width:1"
                id="rect3427"
                width="15.000002"
                height="4.9999971"
                x="68.583969"
                y="144.13753" />
              <rect
                style="fill:#008000;stroke-width:1"
                id="rect2567-2"
                width="14.999999"
                height="4.9999995"
                x="53.583973"
                y="144.13754" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3-0"
                width="19.999987"
                height="4.9999976"
                x="88.583977"
                y="144.13754" />
              <g
                transform="translate(53.583971,144.13754)"
                id="g2283-6-2">
                <g
                  id="g2277-7-3">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9-8" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6-4" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8-8" />
                </g>
                <g
                  id="g2279-7-4" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9-5" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-39.590249,-89.083092)"
              id="text7492-4"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494-4);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1683"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1681">_expand(x, 6);</tspan></tspan></text>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-41.524719,-140.84204)"
              id="text56158"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect56160);fill:#008000;fill-opacity:1;stroke:none"><tspan
                x="219.67969"
                y="669.09375"
                id="tspan1687"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1685">++end, return x</tspan></tspan></text>
          </g>
          <g
            class="fragment"
            id="g1186">
            <g
              id="g4162"
              transform="translate(-52.858073,-100)">
              <rect
                style="opacity:1;fill:#00ff00;stroke-width:1"
                id="rect3427"
                width="15.000002"
                height="4.9999971"
                x="68.583969"
                y="144.13753" />
              <rect
                style="fill:#008000;stroke-width:1"
                id="rect2567-2"
                width="14.999999"
                height="4.9999995"
                x="53.583973"
                y="144.13754" />
              <rect
                style="fill:#ff0000;stroke-width:1"
                id="rect2067-3-0"
                width="19.999987"
                height="4.9999976"
                x="88.583977"
                y="144.13754" />
              <g
                transform="translate(53.583971,144.13754)"
                id="g2283-6-2">
                <g
                  id="g2277-7-3">
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 5,0 V 5"
                    id="path2239-5-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 10,0 V 5"
                    id="path2241-3-5" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 15,0 V 5"
                    id="path2243-5-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 20,0 V 5"
                    id="path2245-6-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 25,0 V 5"
                    id="path2247-2-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 30,0 V 5"
                    id="path2249-9-8" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 35,0 V 5"
                    id="path2251-1-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 40,0 V 5"
                    id="path2253-2-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 45,0 V 5"
                    id="path2255-7-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 50,0 V 5"
                    id="path2257-0-6" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 55,0 V 5"
                    id="path2259-9-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 60,0 V 5"
                    id="path2261-3-2" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 65,0 V 5"
                    id="path2263-6-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 70,0 V 5"
                    id="path2265-0-3" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 75,0 V 5"
                    id="path2267-6-1" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 80,0 V 5"
                    id="path2269-2-9" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 85,0 V 5"
                    id="path2271-6-4" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 90,0 V 5"
                    id="path2273-1-7" />
                  <path
                    style="fill:none;stroke:#000000;stroke-width:0.264583"
                    d="M 95,0 V 5"
                    id="path2275-8-8" />
                </g>
                <g
                  id="g2279-7-4" />
                <rect
                  x="0"
                  y="0"
                  width="100"
                  height="5"
                  style="fill:none;stroke:#000000;stroke-width:0.264583"
                  id="rect2281-9-5" />
              </g>
            </g>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-39.177179,-72.426849)"
              id="text7492-4-0"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect7494-4-3);fill:#004380;fill-opacity:1;stroke:none"><tspan
                x="153.92383"
                y="435.41016"
                id="tspan1691"><tspan
                  style="font-family:monospace;-inkscape-font-specification:monospace"
                  id="tspan1689">_expand(x, 9);</tspan></tspan></text>
            <text
              xml:space="preserve"
              transform="matrix(0.26458333,0,0,0.26458333,-41.1827267,-123.75277)"
              id="text56158-8"
              style="font-style:normal;font-weight:normal;font-size:16px;line-height:1.25;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect56160-7);fill:#008000;fill-opacity:1;stroke:none"><tspan
                x="219.67969"
                y="669.09375"
                id="tspan1693">return NULL</tspan></text>
          </g>
        </svg>
      </section>

      <section class="slide">
        <h3><code>std::vector</code> и <code>realloc</code></h3>
        <br/>
        <ul>
          <li class="fragment"><code class="cinline">memcpy</code> disregards constructors and destructors</li>
          <li class="fragment"><code class="cinline">_expand</code> can actually work</li>
          <li class="fragment">It's sad that expanding is not more popular</li>
          <li class="fragment"><code class="cinline">_expand</code> can be implemented for any allocator</li>
          <li class="fragment">C++23's <code class="cinline">allocate_at_least</code> is a poor attempt to help</li>
          <li class="fragment">But what if <span class="fancy">we dont care about constructors and destructors?</span></li>
        </ul>
      </section>

      <section>
        <h3><code>pod_vector</code></h3>
      </section>

      <section class="slide">
        <h3><code>itlib::pod_vector</code></h3>
        <br/>
        <ul>
          <li>When we don't care about constructors and destructors</li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/pod_vector.hpp" target="_blank">gh/iboB/itlib/pod_vector.hpp</a></li>
          <li class="fragment">There are likely other implementations</li>
          <li class="fragment">Memory is transferred <code class="cinline">realloc</code>, <code class="cinline">memcpy</code>, <code class="cinline">memmove</code>...</li>
          <li class="fragment">... and <code class="cinline">_expand</code> if available</li>
          <li class="fragment">Also the other things: <span class="fancy">Debug performance</span>, <span class="fancy">no exceptions on <code>at</code></span></li>
          <li class="fragment">Recast</li>
          <li class="fragment"><a href="https://godbolt.org/z/b4ocaTzn1" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section class="slide">
        <h3>More Thoughts</h3>
        <br/>
        <ul>
          <li class="fragment"><code class="cinline">optimal_alloc_vector</code>: uses <code class="cinline">_expand</code></li>
          <li class="fragment"><code class="cinline">uber_vector</code>: can be any of these</li>
          <li class="fragment"><code class="cinline">std::vector</code> is still quite powerful</li>
          <li class="fragment">Much of this can be done via allocators <span class="fancy">with a small cost</span></li>
        </ul>
      </section>

      <section>
        <h3>But what now?</h3>
        <p>We have <span class="fancy">a bajillion vector types</span>. How do we write an algorithm?</p>
      </section>

      <section>
        <code class="cinline">void work(const std::vector&lt;obj&gt;&amp; data);</code>
        <p>doesn't work anymore</p>
      </section>

      <section>
        <p>Templates, of course work, but <span class="fancy">at a cost</span>.</p>
        <p class="fragment">And don't get me started on ranges!</p>
      </section>

      <section>
        <p>How about</p>
        <code class="cinline">void work(const obj* buf, size_t size);</code>
        <p class="fragment">The answer is yes!</p>
      </section>

      <section>
        <h3>This is <code>std::span</code></h3>
      </section>

      <section class="slide">
        <h3><code>std::span</code></h3>
        <br/>
        <ul>
          <li>Packs pointer and size</li>
          <li class="fragment">It's a trivial idea</li>
          <li class="fragment">Allows ranged for loops</li>
          <li class="fragment">Allows template algorithms</li>
          <li class="fragment">An idea that's been around from the dawn of C++</li>
        </ul>
      </section>

      <section>
        <h3><code class="cinline">std::span</code> alternatives</h3>
        <p class="fragment">All about features</p>
      </section>

      <section class="slide">
        <h3><code>my::span</code></h3>
        <br/>
        <ul>
          <li class="fragment"><a href="https://en.cppreference.com/w/cpp/container/span">C++20 <code>std::span</code></a></li>
          <li class="fragment"><a href="https://www.boost.org/doc/libs/1_78_0/libs/core/doc/html/core/span.html" target="_blank"><code>boost::span</code></a></li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/span.hpp" target="_blank"><code>itlib::span</code></a></li>
          <li class="fragment">... and likely hundreds more</li>
          <li class="fragment"><a href="https://godbolt.org/z/W1dqsr5ET" target="_blank">Demo</a></li>
        </ul>
      </section>

      <section>
        <p>What about more features?</p>
      </section>

      <section>
        <pre><code class="cpp hljs" data-noescape>
    float cool_algorithm(std::span&lt;const float&gt; data);
    // ...
    struct point { float x, y, z; };
    // ...
    itlib::pod_vector&lt;point&gt; points;
    // call cool_algorithm for all .y components?
        </code></pre>
        <img class="fragment diagram" src="round-hole-square-peg.webp" />
      </section>

      <section class="slide">
        <h3>Fat Pointers</h3>
        <br/>
        <li class="fragment">A pointer with additional data</li>
        <li class="fragment"><code class="clnline">span</code>s are fat pointers</li>
        <li class="fragment">Can we have fat spans?</li>
      </section>

      <section>
        <h3><code>stride_span</code></h3>
      </section>

      <section class="slide">
        <h3><code>stride_span</code></h3>
        <br/>
        <ul>
          <li>Pack pointer, size, <span class="fancy">and stride</span></li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/stride_span.hpp" target="_blank"><code>itlib::stride_span</code></a></li>
        </ul>
        <pre class="fragment"><code class="cpp hljs" data-noescape>
    float cool_algorithm(itlib::stride_span&lt;const float&gt; data);
    // ...
    struct point { float x, y, z; };
    // ...
    itlib::pod_vector&lt;point&gt; points;
    // ..
    auto f = cool_algorithm(
      <span class="hl-code-i">itlib::make_stride_span_member_view(points, points.size(), &point::y)</span>
      );
        </code></pre>
        <p class="fragment" style="text-align:right"><a href="https://github.com/iboB/vec-span-demo/blob/master/stride_span.cpp" target="_blank">Demo</a></p>
      </section>

      <section>
        <pre><code class="cpp hljs" data-noescape>
    class point {
      float c[3];
    public:
      float x() const { return x[0]; }
      float y() const { return x[1]; }
      float z() const { return x[2]; }
    };
        </code></pre>
        <img class="diagram" src="doesnt-fit.gif" />
      </section>

      <section class="slide">
        <h3>A Poor Man's Solution</h3>
        <br/>
        <pre><code class="cpp hljs" data-noescape>
    struct point_y_wrap {
      <span class="hl-code fragment">const point&amp; p;</span>
      <span class="hl-code fragment">point_y_wrap(const point&amp; p) : p(p) {}</span>
      <span class="hl-code fragment">operator float() const { retrun p.x(); }</span>
    };
    // ...
    <span class="hl-code fragment">vector&lt;point_y_wrap&gt; vec(points.begin(), points.end());</span>
        </code></pre>
        <ul>
          <li class="fragment"><code class="cinline">cool_algorithm</code> must be a template</li>
          <li class="fragment">We allocate to proxy a buffer which <span class="fancy">is already there</span></li>
        </ul>
      </section>

      <section>
        <p><code class="cinline">point_y_wrap</code> is a polymorphic wrapper</p>
      </section>

      <section>
        <h3><code>poly_span</code></h3>
      </section>

      <section class="slide">
        <h3><code>poly_span</code></h3>
        <ul>
          <li>Pack pointer, size, <span class="fancy">and a function</span></li>
          <li class="fragment"><a href="https://github.com/iboB/itlib/blob/master/include/itlib/stride_span.hpp" target="_blank"><code>itlib::stride_span</code></a></li>
        </ul>
        <pre class="fragment"><code class="cpp hljs" data-noescape>
  float cool_algorithm(itlib::poly_span&lt;const float&gt; data);
  // ...
  struct point { float y() const; /*...*/};
  // ...
  itlib::pod_vector&lt;point&gt; points;
  // ..
  auto f = cool_algorithm(
    <span class="hl-code-i">itlib::poly_span(points.data(), points.size(), [](const point& p) -> float {
      return p.y();
    }</span>
  );
        </code></pre>
        <p class="fragment" style="text-align:right"><a href="https://github.com/iboB/vec-span-demo/blob/master/stride_span.cpp" target="_blank">Demo</a></p>
      </section>

      <section>
        <p>But what about ranges?</p>
      </section>

      <section>
        <img src="nope.png" />
      </section>

      <section class="slide">
        <h3>Ranges</h3>
        <br/>
        <li class="fragment">C++ is not yet ready for ranges</li>
        <li class="fragment">Compile times are abysmal</li>
        <li class="fragment">Performance suffers: link</li>
        <li class="fragment">Always open source</li>
        <li class="fragment">They can lead to fancy and cool code</li>
        <li class="fragment">... but are ultimately useless</li>
        <li class="fragment">Demo</li>
      </section>

      <section>
        <img class="diagram" src="nedry.jpg" />
      </section>

      <section>
        <img class="diagram" src="../unrealized-alpha/jesus.jpg" />
        <p>But that's just, like, my opinion, man</p>
      </section>

      <section class="slide">
        <h3>Bonus</h3>
        <br/>
        <ul>
          <li class="fragment"><a href="https://github.com/iboB/itlib" target="_blank">gh/iboB/itlib</a></li>
          <ul>
            <li class="fragment"><code class="cinline">ufunction</code> - capture non-copyable (like <code class="cinline">unique_ptr</code>)</li>
            <li class="fragment"><code class="cinline">flat_map, flat_set</code> - map with cache locality</li>
            <li class="fragment"><code class="cinline">sentry</code> - finally-type blocks</li>
            <li class="fragment">Other, more niche stuff</li>
          </ul>
          <li class="fragment"><a href="https://github.com/iboB/mscharconv" target="_blank">gh/iboB/mscharconv</a> - charconv for cavemen</li>
        </ul>
      </section>

      <section>
        <h1>End</h1>
        <h2>Questions?</h2>
        <p>Borislav Stanimirov / <a href="https://ibob.bg">ibob.bg</a> / <a href="https://twitter.com/stanimirovb">@stanimirovb</a></p>
        <p>
          <small>
          These slides: <a href="https://ibob.bg/slides/beyond-vec-span/">ibob.bg/slides/beyond-vec-span/</a>
          </small>
          <br />
          <small>
          Demo code: <a href="https://github.com/iboB/vec-span-demo/">github.com/iboB/vec-span-demo</a>
          </small>
          <br />
          <small>
          Slides license <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons By 4.0</a><br /><a rel="license" href="https://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
          </small>
        </p>
      </section>

    </div>
  </div>

  <script src="../lib/reveal.js-3.8.0/js/reveal.min.js"></script>
  <script src="../lib/slides.js"></script>

  <script>
    Reveal.initialize({
      width: 1280,
      height: 720,

      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: 'none', // none/fade/slide/convex/concave/zoom

      autoPlayMedia: false,
      preloadIframes: false,

      // Optional libraries used to extend on reveal.js
      dependencies: [
        //{ src: 'markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        //{ src: 'markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'highlight/highlight.min.js', async: true, callback: function() {
          hljs.initHighlightingOnLoad();
        } },
        //{ src: 'zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
        //{ src: 'notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
      ].map(p => { p.src = '../lib/reveal.js-3.8.0/plugin/' + p.src; return p; })
    });

    slides.footerSetup('is.gd/bvecspan', '2022');
  </script>

</body>
</html>
